<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音到图片：豆包 Seedream 版</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #generatedImage {
            max-width: 100%;
            max-height: 500px;
            margin-top: 20px;
            display: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover {
            background-color: #cc0000;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background-color: #4CAF50;
        }
        .stop-btn:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
            min-height: 24px;
        }
        #loading {
            display: none;
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <h1>语音交互：说话触发，生成对应图片</h1>
    <p>说“小熊”或其他词语，会通过豆包 Seedream API 生成对应的图片和场景</p>
    <button id="toggleBtn">开始监听</button>
    <div id="status">点击按钮开始说话...</div>
    <div id="loading">API 接口调用中，生成图片，请稍候...</div>
    <img id="generatedImage" alt="生成的图片">

    <script>
        // 注意：生产环境请将 API Key 移至后端服务，不要在前端暴露
        const API_KEY = '你的API密钥'; // 替换为你的豆包 API Key（仅保留密钥部分，不含Bearer）
        const BASE_API_URL = 'https://ark.cn-beijing.volcengineapi.com/api/v3';
        
        // 初始化语音识别
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'zh-CN';
        recognition.interimResults = false;
        recognition.continuous = true;
        recognition.maxAlternatives = 1;

        // DOM 元素
        const toggleBtn = document.getElementById('toggleBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const generatedImage = document.getElementById('generatedImage');
        let isListening = false;

        // 构建代理 URL（使用不同的 CORS 代理方案）
        function getProxiedUrl(url) {
            // 使用另一种代理格式，可能更稳定
            return `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        }

        // 生成图片函数（优化版）
        async function generateImage(prompt) {
            loading.style.display = 'block';
            generatedImage.style.display = 'none';
            status.textContent = `正在生成 "${prompt}" 的图片...`;
            status.className = '';

            try {
                // 构建完整的 API URL
                const fullUrl = `${BASE_API_URL}/images/generations`;
                
                // 准备请求参数
                const requestData = {
                    model: 'doubao-seedream-4.0-t2i',
                    prompt: prompt,
                    n: 1,
                    size: '1024x1024',
                    response_format: 'url'
                };

                // 使用代理发送请求（处理 CORS）
                const proxyUrl = getProxiedUrl(fullUrl);
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`
                        },
                        body: JSON.stringify(requestData)
                    })
                });

                // 处理代理响应
                const data = await response.json();
                
                // 解析代理返回的原始响应
                if (data && data.contents) {
                    const apiResponse = JSON.parse(data.contents);
                    
                    if (apiResponse.data && apiResponse.data[0] && apiResponse.data[0].url) {
                        generatedImage.src = apiResponse.data[0].url;
                        generatedImage.style.display = 'block';
                        status.textContent = `生成成功：${prompt}`;
                        status.className = 'success';
                    } else {
                        throw new Error('API 返回格式不正确: ' + JSON.stringify(apiResponse));
                    }
                } else {
                    throw new Error('代理服务返回异常: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('生成图片错误:', error);
                status.textContent = `生成失败: ${error.message}。请检查API密钥和网络。`;
                status.className = 'error';
            } finally {
                loading.style.display = 'none';
            }
        }

        // 按钮点击事件
        toggleBtn.addEventListener('click', () => {
            if (!isListening) {
                try {
                    recognition.start();
                    toggleBtn.textContent = '停止监听';
                    toggleBtn.classList.add('stop-btn');
                    isListening = true;
                    status.textContent = '正在监听，说点什么吧...';
                    status.className = '';
                } catch (err) {
                    status.textContent = '无法启动监听: ' + err.message;
                    status.className = 'error';
                }
            } else {
                recognition.stop();
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
                status.textContent = '监听已停止。';
                status.className = '';
            }
        });

        // 语音识别结果处理
        recognition.onresult = async (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (transcript) {
                status.textContent = `识别到: ${transcript}`;
                await generateImage(transcript);
            }
        };

        // 语音识别错误处理
        recognition.onerror = (event) => {
            console.error('语音识别错误:', event.error);
            status.textContent = `语音识别出错: ${event.error}`;
            status.className = 'error';
            
            // 出错时自动停止监听
            if (isListening) {
                toggleBtn.click();
            }
        };

        // 语音识别结束处理
        recognition.onend = () => {
            if (isListening) {
                // 如果需要持续监听，这里可以重新启动
                status.textContent = '监听已中断，点击按钮重新开始。';
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
            }
        };
    </script>
</body>
</html>
