<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音到图片：豆包 Seedream 版（CORS 代理）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f0f0f0;
        }
        #generatedImage {
            max-width: 400px;
            max-height: 400px;
            margin-top: 20px;
            display: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover {
            background-color: #cc0000;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background-color: #4CAF50;
        }
        .stop-btn:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
            min-height: 20px;
        }
        #loading {
            display: none;
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>语音交互：说话触发，生成对应图片</h1>
    <p>说“小熊”或其他词语，会通过豆包 Seedream API 生成对应的图片和场景</p>
    <p><em>注意：已集成免费 CORS 代理（corsproxy.io），适合 GitHub Pages 测试。替换 API Key（生产勿暴露）。</em></p>
    <button id="toggleBtn">开始监听</button>
    <div id="status">点击按钮开始说话...</div>
    <div id="loading">API 接口调用中，生成图片，请稍候...</div>
    <img id="generatedImage" alt="生成的图片">

    <script>
        const API_KEY = 'bbb75c8d-c973-4b43-9409-66cfa88247b5'; // 替换为你的豆包 API Key（Bearer 前缀）
        const BASE_API_URL = 'https://ark.cn-beijing.volcengineapi.com/api/v3'; // 北京地域
        const CORS_PROXY = 'https://corsproxy.io/?'; // 免费 CORS 代理（? 后接 i=encoded_url）
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'zh-CN';
        recognition.interimResults = false;
        recognition.continuous = true;

        const toggleBtn = document.getElementById('toggleBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const generatedImage = document.getElementById('generatedImage');
        let isListening = false;

        // 辅助函数：构建代理 URL（代理支持 GET/POST，但 Authorization 可能需测试）
        function getProxiedUrl(path, method = 'POST') {
            const targetUrl = `${BASE_API_URL}${path}`;
            const encodedUrl = encodeURIComponent(targetUrl);
            return `${CORS_PROXY}i=${encodedUrl}`;
        }

        // 生成图片函数（同步，简化版）
        async function generateImage(prompt) {
            loading.style.display = 'block';
            generatedImage.style.display = 'none';
            status.textContent = 'API 接口调用中...';
            try {
                const path = '/images/generations';
                const proxyUrl = getProxiedUrl(path);
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}` // 测试若被代理过滤，用后端
                    },
                    body: JSON.stringify({
                        model: 'doubao-seedream-4.0-t2i', // 或 'seedream-4.0-t2i-250828'
                        prompt: prompt, // 直接用语音文本（中文友好）
                        n: 1, // 生成1张
                        size: '1024x1024', // 支持 512x512, 1024x1024 等
                        response_format: 'url' // 返回 URL
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                if (data.data && data.data[0].url) {
                    generatedImage.src = data.data[0].url;
                    generatedImage.style.display = 'block';
                    status.textContent = `生成成功：${prompt}`;
                } else {
                    throw new Error('无图片 URL: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('API Error:', error);
                status.textContent = `生成失败：${error.message}. 检查 Key/代理 或网络。`;
            } finally {
                loading.style.display = 'none';
            }
        }

        toggleBtn.addEventListener('click', () => {
            if (!isListening) {
                recognition.start();
                toggleBtn.textContent = '停止监听';
                toggleBtn.classList.add('stop-btn');
                isListening = true;
                status.textContent = '正在监听，说“小熊”或其他词语试试！';
            } else {
                recognition.stop();
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
                status.textContent = '监听已停止。';
                generatedImage.style.display = 'none';
            }
        });

        recognition.onresult = async (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            status.textContent = `你说了：${transcript}`;
            if (transcript.trim()) {
                await generateImage(transcript);
            }
        };

        recognition.onerror = (event) => {
            status.textContent = '语音识别出错：' + event.error;
            if (isListening) {
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
            }
        };

        recognition.onend = () => {
            if (isListening) {
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
                status.textContent = '监听结束。点击按钮重新开始。';
            }
        };
    </script>
</body>
</html>
