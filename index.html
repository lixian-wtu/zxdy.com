<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音到图片：阿里云通义万相版（CORS 代理）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f0f0f0;
        }
        #generatedImage {
            max-width: 400px;
            max-height: 400px;
            margin-top: 20px;
            display: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover {
            background-color: #cc0000;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background-color: #4CAF50;
        }
        .stop-btn:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
            min-height: 20px;
        }
        #loading {
            display: none;
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>语音交互：说话触发，生成对应图片</h1>
    <p>说“小熊”或其他词语，会通过阿里云 API 生成对应的图片和场景</p>
    <p><em>注意：已集成免费 CORS 代理（corsproxy.io），适合 GitHub Pages 测试。API Key 已移除，请自行添加（生产环境勿暴露）。</em></p>
    <button id="toggleBtn">开始监听</button>
    <div id="status">点击按钮开始说话...</div>
    <div id="loading">API 接口调用中，生成图片，请稍候...</div>
    <img id="generatedImage" alt="生成的图片">

    <script>
        const API_KEY = 'sk-c4949466fb1d4ba1be494624a21823e0'; // ⚠️ 警告：生产环境移除此 Key 或用后端代理！测试后立即替换/删除
        const BASE_API_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1'; // 基础 URL
        const CORS_PROXY = 'https://corsproxy.io/'; // 免费 CORS 代理，支持 POST/GET
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'zh-CN';
        recognition.interimResults = false;
        recognition.continuous = true;

        const toggleBtn = document.getElementById('toggleBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const generatedImage = document.getElementById('generatedImage');
        let isListening = false;

        // 辅助函数：构建代理 URL
        function getProxiedUrl(path) {
            const targetUrl = `${BASE_API_URL}${path}`;
            return `${CORS_PROXY}${encodeURIComponent(targetUrl)}`;
        }

        // 生成图片函数（异步，使用代理）
        async function generateImage(prompt) {
            loading.style.display = 'block';
            generatedImage.style.display = 'none';
            status.textContent = 'API 接口调用，创建任务...';
            try {
                // 步骤1: 创建任务（POST 通过代理）
                const createPath = '/services/aigc/text2image/image-synthesis';
                const createProxyUrl = getProxiedUrl(createPath);
                const createResponse = await fetch(createProxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 注意：代理可能过滤 Authorization，测试后若无效，用环境变量或后端
                        'Authorization': `Bearer ${API_KEY}`,
                        'X-DashScope-Async': 'enable'
                    },
                    body: JSON.stringify({
                        model: 'wan2.2-t2i-flash', // 极速版，速度快
                        input: {
                            prompt: prompt, // 直接用语音文本
                            negative_prompt: '模糊，低质量' // 可选：避免低质
                        },
                        parameters: {
                            size: '1024*1024',
                            n: 1 // 生成1张
                        }
                    })
                });
                const createData = await createResponse.json();
                if (createData.output && createData.output.task_id) {
                    const taskId = createData.output.task_id;
                    status.textContent = '任务创建成功，正在生成图片...';

                    // 步骤2: 轮询任务结果（GET 通过代理，每2秒查一次，最多15次≈30秒）
                    let attempts = 0;
                    const maxAttempts = 15;
                    const pollInterval = setInterval(async () => {
                        attempts++;
                        const pollPath = `/tasks/${taskId}`;
                        const pollProxyUrl = getProxiedUrl(pollPath);
                        const pollResponse = await fetch(pollProxyUrl, {
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`
                            }
                        });
                        const pollData = await pollResponse.json();
                        if (pollData.output && pollData.output.task_status === 'SUCCEEDED') {
                            clearInterval(pollInterval);
                            if (pollData.output.results && pollData.output.results[0].url) {
                                // 图片 URL 来自阿里云，直接用（CORS 已处理）
                                generatedImage.src = pollData.output.results[0].url;
                                generatedImage.style.display = 'block';
                                status.textContent = `生成成功：${prompt}`;
                            } else {
                                throw new Error('无图片 URL');
                            }
                        } else if (pollData.output?.task_status === 'FAILED' || attempts >= maxAttempts) {
                            clearInterval(pollInterval);
                            throw new Error(pollData.output ? '任务失败' : '超时');
                        }
                    }, 2000);
                    // 注意：finally 会隐藏 loading，但轮询可能仍在运行；实际中可添加超时清理
                } else {
                    throw new Error('任务创建失败: ' + JSON.stringify(createData));
                }
            } catch (error) {
                console.error('API Error:', error);
                status.textContent = `生成失败：${error.message}. 检查代理/Key 或网络。`;
            } finally {
                loading.style.display = 'none';
            }
        }

        toggleBtn.addEventListener('click', () => {
            if (!isListening) {
                recognition.start();
                toggleBtn.textContent = '停止监听';
                toggleBtn.classList.add('stop-btn');
                isListening = true;
                status.textContent = '正在监听，说“小熊”或其他词语试试！';
            } else {
                recognition.stop();
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
                status.textContent = '监听已停止。';
                generatedImage.style.display = 'none';
            }
        });

        recognition.onresult = async (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            status.textContent = `你说了：${transcript}`;
            if (transcript.trim()) {
                await generateImage(transcript);
            }
        };

        recognition.onerror = (event) => {
            status.textContent = '语音识别出错：' + event.error;
            if (isListening) {
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
            }
        };

        recognition.onend = () => {
            if (isListening) {
                toggleBtn.textContent = '开始监听';
                toggleBtn.classList.remove('stop-btn');
                isListening = false;
                status.textContent = '监听结束。点击按钮重新开始。';
            }
        };
    </script>
</body>
</html>